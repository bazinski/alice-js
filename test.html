<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <link rel="stylesheet" type="text/css" media="screen" href="main.css"> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.2/d3.min.js"></script>
    <script src="data.js"></script>
    <style>
        .SSC-LinearStack {
            fill: lightslategray;
            stroke: none;
        }

        .SSC-LinearStack.hit {
            fill: red;
            stroke: black;
        }
    </style>
</head>

<body>
    <div>
        <svg id="stackSector" width="200px">

        </svg>
        <svg id="sectorLayer">

        </svg>
    </div>
    <script>
        // Constants
        const nSTACKS = 5;
        const nSECTORS = 18;
        const nLAYERS = 6;
        const nLINEARSTACKS = nSTACKS * nSECTORS;

        // Conventions
        // LinearStackIndex = Sector * nSTACKS + Stack
        // Detector = LinearStackIndex * nLAYERS + Layer

        // Common functions
        function DetectorToStack(detector) { return Math.floor((detector % (nSTACKS * nLAYERS)) / nLAYERS); } // convert detector (=chamber) number 0-539 to local stack index 0-4
        function DetectorToLayer(detector) { return detector % nLAYERS; } // convert detector (=chamber) number 0-539 to local layer 0-5
        function DetectorToLinearStackIndex(detector) { return Math.floor(detector / nLAYERS); } // convert TRD detector/chamber 0-539 index to linear stack index 0-89
        function DetectorToSector(detector) { return Math.floor(detector / nLAYERS / nSTACKS); } // convert linear stack index 0-89 to TRD sector 0-17
        function StackSectorToLinearStackIndex(stack, sector) { return sector * nSTACKS + stack; } // convert sector 0-17 and stack 0-5 to linear stack index 0-89
    </script>
    <script>
        // Data conversions
        function getTrdTracks(event) {
            return event.TRDTracks
                .map(d => ({
                    Stack: d.Stack,
                    Sector: d.Sector,
                    LinearStackIndex: StackSectorToLinearStackIndex(d.Sector, d.Stack),
                    Tracklets: d.TrdTracklets.map(t => ({
                        Stack: DetectorToStack(t.Detector),
                        Sector: DetectorToSector(t.Detector),
                        Layer: DetectorToLayer(t.Detector),
                        LinearStackIndex: DetectorToLinearStackIndex(t.Detector),
                        Chamber: t.HCId % 2,
                        Detector: t.Detector,
                        HCId: t.HCId,
                    }))
                }));
        }
    </script>
    <script>
        // D3 components
        class StackSectorComponent {
            constructor(width, height, parent) {
                this.height = height;
                this.width = width;

                const componentWidth = this.componentWidth = this.width / nSTACKS;
                const componentHeight = this.componentHeight = this.height / nSECTORS;

                this.g = parent.append("g").attr("class", "stackSector");

                this.linearStackData = d3.range(nLINEARSTACKS)
                    .map(d => ({ index: d, tracks: [] }));

                this.linearStacks = this.g.selectAll("g.SSC-LinearStack")
                    .data(this.linearStackData)
                    .enter()
                    .append("g")
                    .attr("class", "SSC-LinearStack")
                    .attr("transform", d => "translate(" + ((d.index % nSTACKS) * componentWidth) + "," + (Math.floor(d.index / nSTACKS) * componentHeight) + ")");

                this.linearStacks.append("circle")
                    .attr("cx", componentWidth / 2)
                    .attr("cy", componentHeight / 2)
                    .attr("r", Math.min(componentWidth, componentHeight) * 1 / 3);
            }

            draw(event) {
                const trdTracks = getTrdTracks(event);

                for (const lsd of this.linearStackData)
                    lsd.tracks = [];

                for (const trdTrack of trdTracks) {
                    this.linearStackData[trdTrack.LinearStackIndex].tracks.push(trdTrack);
                }

                this.g.selectAll("g.SSC-LinearStack")
                    .classed("hit", d => d.tracks.length > 0);
            }
        }
    </script>
    <script>
        // Event Display
        const stackSector = new StackSectorComponent(200, 200, d3.select("#stackSector").attr("viewBox", "0 0 200 200"));
        //const sectorLayer = new SectorLayer(200, 200, d3.select("#stackSector").attr("viewBox", "0 0 200 200"));
        const data = getData();
        const trdTracks = getTrdTracks(data[0]);

        stackSector.draw(data[0]);        
        //sectorLayer.draw(data[0]);
    </script>
</body>

</html>